<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flutter Project Tree Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#fff; --muted:#667085; --line:#e5e7eb; --chip:#f2f4f7; --accent:#2563eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color:#0b0f19;}
    header { padding: 20px 24px 12px; border-bottom: 1px solid var(--line); }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .hint { color: var(--muted); font-size: 13px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    input, button { padding: 8px 10px; border:1px solid var(--line); border-radius:10px; font-size:14px; }
    button.primary { background: var(--accent); color:#fff; border-color: var(--accent); }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .status { padding: 8px 24px; font-size: 13px; color: #047857; }
    .error { padding: 8px 24px; font-size: 13px; color: #b00020; }
    .layout { display:grid; grid-template-columns: 340px 1fr; height: calc(100vh - 160px); }
    .panel { overflow:auto; }
    .panel.left { border-right:1px solid var(--line); padding:16px 16px 24px; }
    .panel.right { padding:16px 16px 24px; }
    .tree { line-height:1.5; }
    details { margin-left: 12px; }
    summary { cursor: pointer; user-select: none; padding:2px 0; }
    .file { margin-left: 28px; padding:2px 4px; border-radius:6px; cursor:pointer; }
    .file:hover { background: var(--chip); }
    .active { background:#eef2ff !important; }
    .preview-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .breadcrumbs { font-size: 13px; color: var(--muted); }
    .actions { display:flex; gap:6px; }
    .code { background:#0b1020; color:#e6edf3; border-radius:10px; padding:12px; overflow:auto; height: calc(100% - 48px); white-space: pre; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
    .topstrip { border-top:1px solid var(--line); }
    .chips { display:flex; gap:6px; flex-wrap: wrap; }
    .chip { background:var(--chip); color:#111827; border-radius:999px; padding:4px 10px; font-size:12px; }
    .search { display:flex; gap:8px; margin-bottom:10px; }
    pre.jsonbox { background:#f7f7f7; border-radius:10px; padding:10px; overflow:auto; max-height:210px; margin: 10px 24px; }
    @media (max-width: 860px) { .layout { grid-template-columns: 1fr; height: auto; } .panel.left{ border-bottom:1px solid var(--line);} }
  </style>
</head>
<body>
  <header>
    <h1>Flutter Project Tree</h1>
    <div class="hint">Saisis le nom du projet puis clique ‚ÄúG√©n√©rer‚Äù.</div>
    <div class="toolbar">
      <input id="name" placeholder="projectName" value="MonAppli" />
      <button id="go" class="primary">G√©n√©rer</button>
      <button id="downloadJson">T√©l√©charger JSON</button>
    </div>
  </header>

  <div id="msg" class="status"></div>
  <pre id="json" class="jsonbox"></pre>

  <div class="layout topstrip">
    <aside class="panel left">
      <div class="search">
        <input id="filter" placeholder="Rechercher un fichier/dossier‚Ä¶" style="flex:1" />
        <button id="clearFilter">‚úï</button>
      </div>
      <div id="out" class="tree"></div>
    </aside>

    <main class="panel right">
      <div class="preview-head">
        <div>
          <div class="breadcrumbs" id="crumbs">S√©lectionne un fichier‚Ä¶</div>
          <div class="chips" id="fileMeta"></div>
        </div>
        <div class="actions">
          <button id="copy">Copier</button>
        </div>
      </div>
      <div id="code" class="code" tabindex="0">// (aucun fichier s√©lectionn√©)</div>
    </main>
  </div>

<script>
  const API_BASE = "https://flutter-studio-api-881278465156.europe-west1.run.app";

  const out = document.getElementById('out');
  const jsonBox = document.getElementById('json');
  const btn = document.getElementById('go');
  const msg = document.getElementById('msg');
  const nameInput = document.getElementById('name');
  const downloadBtn = document.getElementById('downloadJson');
  const filterInput = document.getElementById('filter');
  const clearFilterBtn = document.getElementById('clearFilter');
  const codeBox = document.getElementById('code');
  const crumbs = document.getElementById('crumbs');
  const fileMeta = document.getElementById('fileMeta');
  const copyBtn = document.getElementById('copy');

  const el = (tag, attrs={}, ...children) => {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) { if (k==='class') n.className=v; else n.setAttribute(k,v); }
    for (const c of children) n.append(c);
    return n;
  };

  function flatToNestedTree(ghTree, rootName) {
    const root = { name: rootName || 'repo', type: 'dir', children: [] };
    if (!ghTree || !Array.isArray(ghTree.tree)) return root;
    for (const item of ghTree.tree) {
      const parts = (item.path || '').split('/').filter(Boolean);
      let parent = root;
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        const isLast = i === parts.length - 1;
        if (isLast) {
          parent.children.push({ name: part, type: item.type === 'tree' ? 'dir' : 'file' });
        } else {
          let node = (parent.children || []).find(c => c.type === 'dir' && c.name === part);
          if (!node) { node = { name: part, type: 'dir', children: [] }; parent.children.push(node); }
          parent = node;
        }
      }
    }
    return root;
  }

  function renderTree(root) {
    if (!root) return;
    out.innerHTML = '';
    out.append(buildNode(root, []));
  }

  function buildNode(node, path) {
    if (node.type === 'dir') {
      const wrap = el('details', { open: true });
      wrap.append(el('summary', {}, 'üìÅ ' + node.name));
      for (const child of (node.children || [])) {
        wrap.append(buildNode(child, path.concat(node.name)));
      }
      return wrap;
    } else {
      const full = path.concat(node.name);
      const div = el('div', { class: 'file', 'data-path': full.join('/') }, 'üìÑ ' + node.name);
      div.addEventListener('click', () => openFile(full));
      return div;
    }
  }

  function openFile(pathArr) {
    crumbs.textContent = '/' + pathArr.join('/');
    fileMeta.innerHTML = '';
    fileMeta.append(el('span', { class: 'chip' }, 'Nom: ' + pathArr[pathArr.length - 1]));
    codeBox.textContent = '(fichier non charg√© depuis API)';
  }

  // --- NEW: polling until the repo tree is ready ---
  async function pollRepoInfo({ owner, repo, branch }, { tries = 60, interval = 2000 } = {}) {
    for (let i = 0; i < tries; i++) {
      try {
        const u = new URL(API_BASE + '/repo-info');
        u.searchParams.set('owner', owner);
        u.searchParams.set('repo', repo);
        u.searchParams.set('branch', branch || 'main');

        const r = await fetch(u.toString());
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();

        if (data && Array.isArray(data.tree) && data.tree.length) {
          return data; // tree ready
        }
      } catch (_) {}
      msg.className = 'status';
      msg.textContent = `Indexation GitHub en cours‚Ä¶ (tentative ${i + 1})`;
      await new Promise(res => setTimeout(res, interval));
    }
    throw new Error('timeout_waiting_for_repo_ready');
  }

  async function generate() {
    btn.disabled = true;
    msg.className = 'status';
    msg.textContent = 'Cr√©ation du d√©p√¥t‚Ä¶';
    out.textContent = '';
    jsonBox.textContent = '';
    try {
      const r = await fetch(API_BASE + '/generate-repo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectName: nameInput.value.trim() || 'flutter_studio', private: false })
      });
      const data = await r.json();
      if (!data.ok) throw new Error(data.message || 'Erreur inconnue');

      const owner = data.owner;
      const repo  = data.repo;
      const branch = data.default_branch || 'main';

      // Si l‚Äôarbre n‚Äôest pas pr√™t, on poll automatiquement jusqu‚Äô√† ce qu‚Äôil apparaisse
      let ghTree = data.tree;
      if (!ghTree) {
        msg.innerHTML = '‚úÖ D√©p√¥t cr√©√© : <a target="_blank" href="'+data.html_url+'">'+data.html_url+'</a> ¬∑ Indexation en cours‚Ä¶';
        ghTree = await pollRepoInfo({ owner, repo, branch });
      } else {
        msg.innerHTML = '‚úÖ D√©p√¥t cr√©√© : <a target="_blank" href="'+data.html_url+'">'+data.html_url+'</a>';
      }

      const nested = flatToNestedTree(ghTree, repo || (nameInput.value || 'repo'));
      jsonBox.textContent = JSON.stringify(nested, null, 2);
      renderTree(nested);
      msg.innerHTML = '‚úÖ D√©p√¥t pr√™t : <a target="_blank" href="'+data.html_url+'">'+data.html_url+'</a>';

    } catch (e) {
      msg.className = 'error';
      msg.textContent = 'Erreur: ' + (e?.message || e);
    } finally {
      btn.disabled = false;
    }
  }

  downloadBtn.addEventListener('click', () => {
    const blob = new Blob([jsonBox.textContent || '{}'], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'flutter_tree.json'; a.click();
    URL.revokeObjectURL(a.href);
  });
  filterInput.addEventListener('input', () => {});
  clearFilterBtn.addEventListener('click', () => { filterInput.value=''; });
  copyBtn.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(codeBox.textContent || ''); copyBtn.textContent='Copi√© ‚úì'; setTimeout(()=>copyBtn.textContent='Copier',1200); } catch {}
  });
  btn.addEventListener('click', generate);
</script>
</body>
</html>