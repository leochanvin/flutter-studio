<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flutter Project Tree Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    input, button { padding: 8px; }
    details { margin-left: 14px; }
    .file { margin-left: 28px; }
    .tree { line-height: 1.6; }
    .hint { color: #666; font-size: 0.9rem; margin-bottom: 12px; }
    .error { color: #b00020; margin-top: 8px; }
    .status { color: #0a7; margin-top: 8px; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    pre { background:#f7f7f7;padding:12px;border-radius:8px;overflow:auto;max-height:220px }
  </style>
</head>
<body>
  <h1>Flutter Project Tree</h1>
  <div class="hint">Colle l‚ÄôURL Cloud Run (ex: https://‚Ä¶/generate-tree), puis ‚ÄúG√©n√©rer‚Äù.</div>

  <div class="controls">
    <input id="api" placeholder="https://YOUR-CLOUD-RUN-URL/generate-tree" style="min-width:360px" />
    <input id="name" placeholder="projectName" value="MonAppli" />
    <input id="platforms" placeholder="platforms (csv)" value="android,ios,web" />
    <label><input type="checkbox" id="examples" checked> includeExamples</label>
    <button id="go">G√©n√©rer</button>
  </div>

  <div id="msg" class="status"></div>
  <pre id="json"></pre>
  <div id="out" class="tree"></div>

  <script>
    const out = document.getElementById('out');
    const jsonBox = document.getElementById('json');
    const btn = document.getElementById('go');
    const msg = document.getElementById('msg');
    const apiInput = document.getElementById('api');
    const nameInput = document.getElementById('name');
    const platformsInput = document.getElementById('platforms');
    const examplesInput = document.getElementById('examples');

    const el = (tag, attrs={}, ...children) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) n.setAttribute(k,v);
      for (const c of children) n.append(c);
      return n;
    };

    function renderNode(node) {
      if (node.type === 'dir') {
        const d = el('details', { open: true });
        const s = el('summary'); s.textContent = `üìÅ ${node.name}`;
        d.append(s);
        (node.children || [])
          .sort((a,b)=> a.type===b.type ? a.name.localeCompare(b.name) : (a.type==="dir"?-1:1))
          .forEach(child => d.append(renderNode(child)));
        return d;
      }
      const f = el('div', { class: 'file' });
      f.textContent = `üìÑ ${node.name}`;
      return f;
    }

    function saveState() {
      const state = {
        api: apiInput.value.trim(),
        projectName: nameInput.value.trim(),
        platforms: platformsInput.value.trim(),
        includeExamples: examplesInput.checked,
      };
      localStorage.setItem('flutter_studio_viewer_state', JSON.stringify(state));
    }

    function restoreState() {
      try {
        const raw = localStorage.getItem('flutter_studio_viewer_state');
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s.api) apiInput.value = s.api;
        if (s.projectName) nameInput.value = s.projectName;
        if (s.platforms) platformsInput.value = s.platforms;
        if (typeof s.includeExamples === 'boolean') examplesInput.checked = s.includeExamples;
      } catch {}
    }

    async function loadConfigJson() {
      try {
        const r = await fetch('config.json', { cache: 'no-store' });
        if (r.ok) {
          const cfg = await r.json();
          if (cfg?.apiUrl && !apiInput.value) {
            apiInput.value = cfg.apiUrl;
          }
        }
      } catch {
        // silencieux : config.json est optionnel
      }
    }

    async function generate() {
      msg.textContent = "";
      msg.className = "status";
      out.textContent = "Chargement‚Ä¶";
      jsonBox.textContent = "";
      btn.disabled = true;

      const api = apiInput.value.trim();
      const projectName = nameInput.value.trim() || 'flutter_app';
      const platforms = (platformsInput.value || '')
        .split(',').map(s => s.trim()).filter(Boolean);
      const includeExamples = examplesInput.checked;

      if (!api) {
        out.textContent = "";
        msg.textContent = "‚ö†Ô∏è Renseigne l‚ÄôURL de l‚ÄôAPI Cloud Run.";
        msg.className = "error";
        btn.disabled = false;
        return;
      }

      try {
        const res = await fetch(api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectName, platforms, includeExamples })
        });

        if (!res.ok) {
          out.textContent = "";
          msg.textContent = "Erreur API: " + res.status + " " + res.statusText;
          msg.className = "error";
          return;
        }

        const data = await res.json();
        jsonBox.textContent = JSON.stringify(data, null, 2);
        out.innerHTML = "";
        out.append(renderNode(data));
        msg.textContent = "‚úÖ Arborescence g√©n√©r√©e";
        msg.className = "status";

        saveState();
      } catch (e) {
        out.textContent = "";
        msg.textContent = "Erreur r√©seau: " + (e?.message || e);
        msg.className = "error";
      } finally {
        btn.disabled = false;
      }
    }

    // Listeners
    btn.addEventListener('click', generate);
    // Entr√©e ‚Üµ d√©clenche generate quand focus sur un input
    [apiInput, nameInput, platformsInput].forEach(inp => {
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') generate();
      });
    });

    // Au chargement : restaurer √©tat et tenter de charger config.json
    restoreState();
    loadConfigJson();
  </script>
</body>
</html>